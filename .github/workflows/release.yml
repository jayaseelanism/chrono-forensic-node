name: Azure Auth Test
on:
  push:
    tags:
      - 'v*' 

jobs:
  test-azure-connection:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # This step ensures the JSON is clean of any PowerShell weirdness
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true

      - name: Get Certificate String from Key Vault
        uses: azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ secrets.AZURE_KEYVAULT_NAME }}
          secrets: ${{ secrets.AZURE_PFX_SECRET_NAME }}
        id: kv_fetch

      - name: Verify Secret Fetch
        shell: pwsh
        run: |
          Write-Host "Successfully retrieved secret from Key Vault!"
          # This verifies the secret exists without printing the sensitive value
          if ("${{ steps.kv_fetch.outputs.chrono-codesign-pfx }}".Length -gt 0) {
              Write-Host "Secret content is present and ready for decoding."
          } else {
              Write-Host "Secret content is empty. Check Key Vault and secret name."
              exit 1
          }
          }

      - name: Decode and Save PFX
        shell: pwsh
        run: |
          $pfx_base64 = "${{ steps.kv_fetch.outputs.chrono-codesign-pfx }}"
          $pfx_bytes = [System.Convert]::FromBase64String($pfx_base64)
          [System.IO.File]::WriteAllBytes("codesign.pfx", $pfx_bytes)
          Write-Host "PFX file decoded and saved as codesign.pfx"

      # Future steps will involve using this PFX for signing
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Or your desired Node.js version

      - name: Install Node.js Dependencies
        run: npm install

      - name: Build Application

        run: npm run build

      - name: Sign Application
        run: |
          # This step will use the codesign.pfx file to sign the built application.
          # The exact command will depend on your application type and signing tool.
          # Example for Electron/Windows: npx electron-builder --win --x64 --publish never --config.win.signingHashAlgorithms sha256 --config.win.certificateFile codesign.pfx --config.win.certificatePassword ${{ secrets.PFX_PASSWORD }}
          echo "Application signing step placeholder."

          